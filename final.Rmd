```{r}
library(tidyverse)
library(caret)
library(rpart)
library(RWeka)
library(factoextra)
library(gridExtra)
library(tibble)
```

```{r}
csgo_round <- read.csv("csgo_round_snapshots.csv")
```

# Introduction

This will be our introduction.

# Data Preparation

## Data Cleaning

- Don't need money columns
- Don't need players_alive since we are only using first screenshot
- Don't need health since we are only using first screenshot where it's constant
- Group like weapons

### Determining Round Number

```{r}
# Find out when a new round starts
csgo_round <- csgo_round %>% mutate(round_num=case_when(time_left > lag(time_left, 1) & (time_left - lag(time_left) > 5.0) ~ 'New Round', TRUE ~ "Same Round")) %>% relocate(round_num, .before=time_left)

# The first row is always a new round
csgo_round[1,"round_num"] <- 'New Round'
```

### Remove unwanted columns

```{r}
unwanted_cols <- c("round_num", "ct_money", "t_money", "ct_players_alive", "t_players_alive", "time_left", "ct_health", "t_health", "ct_score", "t_score")

csgo_round <- csgo_round[csgo_round$round_num == 'New Round',] %>% select(!all_of(unwanted_cols))
```

### Group like weapons

```{r}
all_grenades <- c("grenade_hegrenade", "grenade_flashbang", "grenade_smokegrenade", "grenade_incendiarygrenade", "grenade_molotovgrenade", "grenade_decoygrenade")

csgo_round$t_grenades <- rowSums(csgo_round[,paste0("t_", all_grenades)])
csgo_round$ct_grenades <- rowSums(csgo_round[,paste0("ct_", all_grenades)])

csgo_round <- csgo_round %>% select(-contains(all_grenades))

all_pistols <- c("weapon_glock", "weapon_usps", "weapon_p250", "weapon_tec9", "weapon_p2000", "weapon_fiveseven", "weapon_cz75auto", "weapon_deagle", "weapon_r8revolver", "weapon_elite")
special_pistols <- c("weapon_p250", "weapon_tec9", "weapon_fiveseven", "weapon_cz75auto", "weapon_deagle", "weapon_r8revolver", "weapon_elite")

csgo_round$t_pistols <- rowSums(csgo_round[,paste0("t_", special_pistols)])
csgo_round$ct_pistols <- rowSums(csgo_round[,paste0("ct_", special_pistols)])

csgo_round <- csgo_round %>% select(-contains(all_pistols))

all_shotguns <- c("weapon_nova", "weapon_xm1014", "weapon_mag7", "weapon_sawedoff")

csgo_round$t_shotguns <- rowSums(csgo_round[,paste0("t_", all_shotguns)])
csgo_round$ct_shotguns <- rowSums(csgo_round[,paste0("ct_", all_shotguns)])

csgo_round <- csgo_round %>% select(-contains(all_shotguns))

all_smgs <- c("weapon_mac10", "weapon_mp9", "weapon_ump45", "weapon_mp7", "weapon_bizon", "weapon_p90", "weapon_mp5sd")

csgo_round$t_smgs <- rowSums(csgo_round[,paste0("t_", all_smgs)])
csgo_round$ct_smgs <- rowSums(csgo_round[,paste0("ct_", all_smgs)])

csgo_round <- csgo_round %>% select(-contains(all_smgs))

all_rifles <- c("weapon_galilar", "weapon_famas", "weapon_ak47", "weapon_m4a4", "weapon_m4a1s", "weapon_sg553", "weapon_aug")

csgo_round$t_rifles <- rowSums(csgo_round[,paste0("t_", all_rifles)])
csgo_round$ct_rifles <- rowSums(csgo_round[,paste0("ct_", all_rifles)])

csgo_round <- csgo_round %>% select(-contains(all_rifles))

all_snipers <- c("weapon_ssg08", "weapon_awp", "weapon_g3sg1", "weapon_scar20")

csgo_round$t_snipers <- rowSums(csgo_round[,paste0("t_", all_snipers)])
csgo_round$ct_snipers <- rowSums(csgo_round[,paste0("ct_", all_snipers)])

csgo_round <- csgo_round %>% select(-contains(all_snipers))

all_machines <- c("weapon_m249", "weapon_negev")

csgo_round$t_machines <- rowSums(csgo_round[,paste0("t_", all_machines)])
csgo_round$ct_machines <- rowSums(csgo_round[,paste0("ct_", all_machines)])

csgo_round <- csgo_round %>% select(-contains(all_machines))

csgo_round <- csgo_round %>% relocate(round_winner, .after=last_col())
```

### Making all character vectors into factors

```{r}
csgo_round <- csgo_round %>% mutate_if(is.character, as.factor)
```

### Downsize Sample

```{r}
set.seed(9)
csgo_round <- rownames_to_column(csgo_round, "index") %>% mutate(index = as.numeric(index))
csgo_round <- sample_n(csgo_round, 5000)
```

### Split into two dataframes, terrorist and counter-terrorist winners

```{r}
listed <- sapply(c("t_", "ct_"), function(x)
                 csgo_round[(startsWith(names(csgo_round), x)) |
                            (startsWith(names(csgo_round), "bomb_planted")) |
                            (startsWith(names(csgo_round), "round_winner")) |
                            (startsWith(names(csgo_round), "map")) |
                            (startsWith(names(csgo_round), "index"))],
                simplify=FALSE)
t_winners <- do.call("rbind", listed[1]) %>% filter(round_winner == "T")
rownames(t_winners) <- NULL

ct_winners <- do.call("rbind", listed[2]) %>% filter(round_winner == "CT")
rownames(ct_winners) <- NULL
```

# Model training

## k-Means Clustering

### Scale values

```{r}
t_winners_scaled <- select_if(t_winners, is.numeric)
t_winners_scaled <- t_winners_scaled[,-which(colSums(select_if(t_winners_scaled, is.numeric)) == 0)]
t_winners_scaled <- scale(t_winners_scaled %>% select(-index))

ct_winners_scaled <- select_if(ct_winners, is.numeric)
ct_winners_scaled <- ct_winners_scaled[,-which(colSums(select_if(ct_winners_scaled, is.numeric)) == 0)]
ct_winners_scaled <- scale(ct_winners_scaled %>% select(-index))
```

### Optimal clusters

```{r}
set.seed(9)
fviz_nbclust(t_winners_scaled, kmeans, method="silhouette")

fviz_nbclust(ct_winners_scaled, kmeans, method="silhouette")
```

### Train k-means models

```{r}
t_kmeans <- kmeans(t_winners_scaled,
                   centers=9,
                   nstart=1000)

ct_kmeans <- kmeans(ct_winners_scaled,
                    centers=2,
                    nstart=1000)
```

### Visualizing the clusters

```{r}
t_clusters = fviz_cluster(t_kmeans, geom = "point", data = t_winners_scaled) + ggtitle("Terrorist Clusters")
ct_clusters = fviz_cluster(ct_kmeans, geom = "point", data = ct_winners_scaled) + ggtitle("Counter-Terrorist Clusters")

grid.arrange(t_clusters, ct_clusters)
```

### Viewing centers

```{r}
View(t_kmeans$centers)
t_strategies <- c(`1` = "Prioritize buying SMGs, occasionally buy armor and helmets", `2` = "Highly prioritize shotguns over anything else", `3` = "Play safely by buying rifles and lots of armor and helmet", `4` = "Prioritize rifles over other weapons", `5` = "Prioritize snipers over other weapons", `6` = "Normal play (or N/A)", `7` = "Rush other side with grenades, pistols, and lots of armor", `8` = "Camp with snipers", `9` = "Prioritize pistols over anything else")

View(ct_kmeans$centers)
ct_strategies <- c(`1` = "Buy the defusing kit, armor, and rifles", `2` = "Normal play (or N/A)")
```

### Assigning clusters

```{r}
t_winners <- data.frame(t_winners, t_kmeans$cluster)
t_winners$t_strategy <- recode(t_winners$t_kmeans.cluster, !!!t_strategies)
t_winners <- t_winners %>% select(-t_kmeans.cluster)
head(t_winners)

ct_winners <- data.frame(ct_winners, ct_kmeans$cluster)
ct_winners$ct_strategy <- recode(ct_winners$ct_kmeans.cluster, !!!ct_strategies)
ct_winners <- ct_winners %>% select(-ct_kmeans.cluster)
head(ct_winners)
```

### Merge data

```{r}
csgo_round_new <- full_join(t_winners, ct_winners)
csgo_round_new[is.na(csgo_round_new)] <- 0
csgo_round_new <- csgo_round_new[order(csgo_round_new$index),]
col_order <- append(colnames(csgo_round), c("t_strategy", "ct_strategy"))
csgo_round_new <- csgo_round_new[,col_order]
rownames(csgo_round_new) <- NULL
csgo_round_new <- csgo_round_new %>% mutate_if(is.character, as.factor)
View(csgo_round_new)
```
